# IoCommander v1.0.0
### Приложение для отправки команд удаленным клиентам через socket.io. Функционал написан на серверном javascript и представлен тремя отдельными частями

#### Скрипт сервера (настройки в файле "src-server\iocommander-server.conf", запуск "node .\src-server\iocommander-server.js"), который 

- Поднимает два сервера:  
  - web-сервер (веб-приложение панели управления, написанное на react + redux + socket.io)
  - socket-сервер (основной сервер приложения)
    
- Имеет два хранилища redux:
  - хранилище соединений (временное)
```
	{	
		users:{
			user1:uid1,
			user2:uid2
		},
		uids:{
			uid1:user1,
			uid2:user2
		}
	
	}
```
  - хранилище данных (постоянное, синхронизируется с firebase):
```
	{	
		users:{
			user1:password1,
			user2:password2
		},
		admins:{
			admin1:password1,
			admin2:password2
		},
		tasks:{
			user1:{
				uid1_task:{},
				uid2_task:{}
			},
			user2:{
				uid1_task:{},
				uid2_task:{}
			}
		}
	}
```

- Имеет хранилище firebase:
  Служит только для синхронизации. При изменении данных в постоянном хранилище - они будут записаны в firebase с отсрочкой в 1 минуту (снимок данных также будет сделан с отсрочкой в 1 минуту). При этом в течении этой минуты повторного запуска функции синхронизации не будет.
  Это позволяет с одной стороны не писать в базу вообще ничего, если данные не обновляются, с другой стороны писать в базу по факту изменений и не dos-ить её частыми транзакциями (соответственно не попасть на блокировку ветви дерева JSON).
  Проще говоря, пишем все изменения в базу с транзакцией не чаще, чем раз в минуту. При старте сервера изымаем JSON-дерево из базы данных, досоздавая недостающие ветви в redux (т.к. fifebase не может хранить объекты типа test:{} ).
  Если база пуста, создаю учетку администратора с именем пользователя administrator, пароль 12345678
  Настройки безопасности, что-то вроде:
```
	{
	  "rules": {
		".read": "(auth.email == 'admin@sergdudko.tk')",
		".write": "(auth.email == 'admin@sergdudko.tk')"
	  }
	}
```

- При подключении к сокету, проверяет данные авторизации. Исходя из этого анализирует принадлежность клиента к администратору или пользователю (или вообще ни к тому, ни к другому). Если клиент - пользователь, может отправлять задания и слушать сокет (отчет о выполнении).
  Если клиент - администратор, слушает сокет на факт создания заданий. Отправляет в сокет соответствующее хранилище redux при изменении в хранилище.
  
- Имеет сборщик мусора, который удаляет выполненные задачи по сроку давности (установил в 30 дней), либо по отсутствующему пользователю. Запускается раз в час.
  

#### Скрипт клиента (настройки в файле "src-user\iocommander-usr.conf", запуск "node .\src-user\iocommander-usr.js"), который:

- Соединяется с сокетом-сервера и авторизуется в нем.
  
- Слушает сокет сервера на наличие заданий.

- При поступлении задания пишет его в собственное хранилище redux:
```
	{
		tasks: {
			uid1_task:{},
			uid2_task:{}
		}, 
		complete: [
			uid1_task,
			uid2_task
		], 
		incomplete:[]
	}
```
  
- Раз в 15 секунд проверяет невыполненные задания и пытается их выполнить.

- При разрыве соединения автоматически восстанавливает его.

- Анализирует тип операционной системы при выполнении заданий.

- Задание "скачать файл в папку", пример:
```
	{
		uid:'f0b11bc4-83d2-45aa-ba4d-b3fc86198cbf', 
		task: {
			nameTask:'getFileFromWWW', 
			extLink:'http://vpn.sergdudko.tk/releases/dwpanel-2.2.0-1.noarch.rpm', 	//ссылка для скачки
			intLink:'/test/', 														//каталог для записи (для win32 будет записан относительно диска C)
			fileName: '1.rpm', 														//имя файла, может отличатся от исходного
			exec:'false', 
			complete:'false',														//флаг, что задание выполнено
			answer:'', 																//вывод содержимого консоли по факту выполнения команды (обратная связь)
			dependencies:[], 														//зависимости, выполнение команды возможно, только если зависимости выполнены.
			platform:'all'															//тип операционной системы (all, win32 или linux)
		}
	}
```  

- Задание "Запустить локальный скрипт", пример:
```
	{
		uid:'f0b11bc4-83d2-45aa-ba4d-b3fc86198cbf', 
		task: {
			nameTask:'execFile', 
			intLink:'', 															//папка с скриптом
			fileName: 'node', 														//имя файла
			paramArray:['--version'], 												//параметры запуска
			complete:'false', 
			answer:'', 
			dependencies:['efc0a00f-00b3-489d-be28-b1760be01618'],
			platform:'linux'
		}
	}
```  

- Задание "Выполнить команду", пример:
```
	{
		uid:'f0b11bc4-83d2-45aa-ba4d-b3fc86198cbf', 
		task: {
			nameTask:'execCommand', 
			execCommand:'echo 111', 												//команда для выполнения
			platform:'win32', 														//тип операционной системы задан жестко, т.е. только win32 или linux
			dependencies:[
				'efc0a00f-00b3-489d-be28-b1760be01618', 
				'f0b11bc4-83d2-45aa-ba4d-b3fc86198cbf'
			]
		}
	}
```  
  
#### Веб-панель администратора

- Умеет авторизовавыться в сокете
  
- Автоматически получает измененные данные из сокета (два аналогичных серверу хранилища)

- Имеет собственное redux хранилище для функционирования админки

- реализовано на react framework
